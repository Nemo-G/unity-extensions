# 开发经验文档

## 编写原则
- **通用性**: 避免游戏特定术语，经验应适用于各种游戏开发
- **简洁性**: 描述简洁明了，避免冗余，代码示例只保留关键部分

## 基本信息
- **创建日期**: 2026-02-25
- **相关任务**: Angry Birds 风格游戏开发
- **技术栈**: Unity 2D

## 问题描述

### 问题表现
1. 轨迹预览不显示
2. 只有一只鸟，鸟飞走后不生成新鸟
3. 猪被撞击后不死亡

### 根本原因
1. **轨迹预览**：BirdController.UpdateAimPosition 没有调用 TrajectoryPreview.Show()
2. **鸟不生成**：BirdController 在 OnDestroy 中没有处理飞行中被销毁的情况，导致 BirdQueueManager 不知道鸟已经消失
3. **猪不死亡**：碰撞检测阈值(deathThreshold)设置过高，与发射力度参数不匹配

## 用户手动修复内容

### 1. 场景中 Pig 实例参数调整
用户将场景中 Pig 实例的参数调整为：
- `health = 1` (原值 50)
- `deathThreshold = 0.5` (原值 30)

**原因**：原值太高，鸟的最大碰撞力无法触发猪死亡。用户通过大幅降低阈值确保猪可以被杀死。

### 2. BirdController 添加 OnDestroy 处理
用户在 BirdController 中添加了 OnDestroy 方法，处理鸟在飞行中被销毁的情况：

```csharp
private void OnDestroy()
{
    // If the bird is destroyed while still flying (e.g. by a Destroyer),
    // notify the queue manager so the next bird can spawn.
    if (currentState == BirdState.Flying)
    {
        NotifyBirdQueueManager();
    }
}
```

**原因**：当鸟飞出边界被 Destroyer 销毁时，需要通知 BirdQueueManager 生成下一只鸟。

### 3. 场景配置调整
- 禁用了 Middleground 背景层（避免遮挡）
- 重命名 Destroyer 对象为 Destroyer_Bottom, Destroyer_Right, Destroyer_Left

## 关键经验总结

### 1. Prefab 实例值 vs 脚本默认值
- 修改脚本中的 `[SerializeField]` 默认值不会自动更新已存在的 Prefab 实例
- 需要手动更新 Prefab 实例的值，或者在代码中动态设置

### 2. 碰撞检测参数匹配
- 碰撞力 = 质量 × 相对速度
- 发射速度 = 拉伸距离 × 发射力度系数
- deathThreshold 必须 < 最大碰撞力，否则猪永远不会死亡
- 建议公式：`deathThreshold <= maxStretchDistance * launchForceMultiplier * birdMass * 0.5`

### 3. 对象生命周期管理
- 当对象可能被外部销毁（如 Destroyer）时，需要在 OnDestroy 中处理清理逻辑
- 使用标志位（如 hasNotifiedQueue）避免重复通知

### 4. 轨迹预览集成
- 轨迹预览需要在拖拽时实时更新
- 调用位置：BirdController.UpdateAimPosition 中，在更新弹弓线之后

---
**文档版本**: v4.0
**维护者**: Experience Manager
**最后更新**: 2026-02-25
